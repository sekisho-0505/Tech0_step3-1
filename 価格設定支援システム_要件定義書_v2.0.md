# 価格設定支援システム 要件定義書（AI実装向け最終版 v2.0）

> **重要**: 本書はAI（LLM/エージェント）による自動実装を前提とした最終仕様書です。
> すべての曖昧表現を排除し、具体的な実装指示として記述しています。
> 本書の記述が最上位仕様であり、実装時の疑義は本書を正とします。

---

## 1. システム概要

### 1.1 システム名
**価格設定支援システム（Pricing Decision Support System / PDSS）**

### 1.2 システムの目的と成功指標

#### 目的
卸売業における価格設定プロセスを**完全にデータドリブン化**し、以下を実現する：
1. **損益分岐点を割らない最低売価**の自動算出
2. **市場競争力のある推奨売価レンジ**の即時提示
3. **価格変更による影響**の事前シミュレーション

#### 成功指標（KPI）
- 価格決定時間：**現状比70%削減**（10分→3分以内）
- 赤字案件発生率：**ゼロ化**（システムによるガード）
- システム稼働率：**99%以上**（営業日ベース）

### 1.3 解決する課題（優先順位付き）

| 優先度 | 課題 | 現状 | 解決後 |
|--------|------|------|---------|
| P0 | 赤字受注リスク | 勘と経験で価格設定 | 最低売価の自動ガード |
| P0 | 損益分岐点の不可視 | 月次締め後に判明 | リアルタイム可視化 |
| P1 | 価格決定の遅延 | 手計算で10分以上 | 即時算出（1秒以内） |
| P1 | 履歴データの散在 | Excel/紙/記憶 | 一元管理・検索可能 |
| P2 | What-if分析不可 | 影響が予測不能 | シミュレーション機能 |

### 1.4 利用者プロファイル

```yaml
primary_user:
  role: 卸売業経営者
  count: 1名
  it_literacy: Excel基本操作可能
  age_range: 40-60歳
  device: デスクトップPC（Windows 10/11）
  display: 1920x1080以上
  browser: Chrome最新版
  usage_time: 平日9:00-18:00
  critical_operations:
    - 見積作成時の価格決定
    - 月次損益確認
    - 価格改定の影響試算
```

---

## 2. 用語定義と計算規則（絶対遵守）

### 2.1 データ型と単位の定義

```typescript
// 単位定義（TypeScript型定義として明記）
type JPY = number;           // 日本円（整数）
type JPYPerKg = number;      // 円/kg（小数3桁まで）
type Rate = number;          // 率（0.000〜0.999）
type Percent = number;       // パーセント表示用（0〜99.9）
type Kilogram = number;      // 重量kg（小数3桁まで）

// DB保存時の規則
interface DatabaseRules {
  money: 'JPY（円）で保存、整数';
  unitPrice: 'JPYPerKg（円/kg）で保存、小数3桁';
  rate: 'Rate（0.xxx形式）で保存、小数4桁';
  quantity: 'Kilogram（kg）で保存、小数3桁';
}

// UI表示時の変換
interface UIConversion {
  money: 'JPY → 千円表示オプション（/1000）';
  rate: 'Rate → Percent（×100）';
  rounding: '四捨五入（0.5以上切り上げ）';
}
```

### 2.2 ビジネスロジック定義（計算式）

```python
# 基本計算式（Python形式で明記）

def calculate_gross_profit_per_kg(unit_price: JPYPerKg, unit_cost: JPYPerKg) -> JPYPerKg:
    """粗利益（円/kg）"""
    return unit_price - unit_cost

def calculate_gross_margin_rate(gross_profit: JPYPerKg, unit_price: JPYPerKg) -> Rate:
    """粗利率"""
    if unit_price == 0:
        raise ValueError("Unit price cannot be zero")
    return gross_profit / unit_price

def calculate_minimum_price(unit_cost: JPYPerKg, target_margin_rate: Rate) -> JPYPerKg:
    """最低売価（損益分岐点を考慮）"""
    if target_margin_rate >= 1.0:
        raise ValueError("Target margin rate must be less than 1.0")
    return unit_cost / (1 - target_margin_rate)

def calculate_break_even_revenue(fixed_cost: JPY, gross_margin_rate: Rate) -> JPY:
    """損益分岐点売上高"""
    if gross_margin_rate == 0:
        raise ValueError("Gross margin rate cannot be zero")
    return fixed_cost / gross_margin_rate

def calculate_variable_cost_rate(variable_cost: JPY, revenue: JPY) -> Rate:
    """変動費率"""
    if revenue == 0:
        return 0
    return variable_cost / revenue
```

### 2.3 丸め規則（実装必須）

```python
import decimal
from decimal import Decimal, ROUND_HALF_UP

class RoundingRules:
    @staticmethod
    def round_jpy(value: float) -> int:
        """金額の丸め（円、整数）"""
        return int(Decimal(str(value)).quantize(Decimal('1'), rounding=ROUND_HALF_UP))
    
    @staticmethod
    def round_jpy_per_kg(value: float) -> float:
        """単価の丸め（円/kg、小数第1位）"""
        return float(Decimal(str(value)).quantize(Decimal('0.1'), rounding=ROUND_HALF_UP))
    
    @staticmethod
    def round_rate(value: float) -> float:
        """率の丸め（小数第4位）"""
        return float(Decimal(str(value)).quantize(Decimal('0.0001'), rounding=ROUND_HALF_UP))
```

### 2.4 バリデーション規則

```python
class ValidationRules:
    # 範囲制約
    MARGIN_RATE_MIN = 0.0
    MARGIN_RATE_MAX = 0.9
    UNIT_COST_MIN = 0.01
    UNIT_COST_MAX = 999999999.999
    QUANTITY_MIN = 0.0
    QUANTITY_MAX = 999999999.999
    
    # 最低売価ガード（絶対ルール）
    @staticmethod
    def validate_minimum_price(proposed_price: JPYPerKg, minimum_price: JPYPerKg) -> tuple[bool, str]:
        """最低売価チェック"""
        if proposed_price < minimum_price:
            return False, f"提案価格 {proposed_price}円/kg は最低売価 {minimum_price}円/kg を下回っています"
        return True, ""
```

---

## 3. システムアーキテクチャ（実装指示）

### 3.1 技術スタック（バージョン固定）

```yaml
frontend:
  framework: Next.js 14.2.x
  language: TypeScript 5.3.x
  ui_library: MUI 5.15.x
  state_management: Zustand 4.5.x
  validation: Zod 3.22.x

backend:
  framework: FastAPI 0.110.x
  language: Python 3.11.x
  orm: SQLAlchemy 2.0.x
  validation: Pydantic 2.6.x

database:
  service: Supabase
  engine: PostgreSQL 15.x
  auth: Supabase Auth
  realtime: Supabase Realtime (optional)

deployment:
  frontend: Vercel
  backend: Railway or Render
  monitoring: Sentry
```

### 3.2 ディレクトリ構造（必須）

```
project-root/
├── frontend/                 # Next.js アプリケーション
│   ├── src/
│   │   ├── app/             # App Router
│   │   ├── components/      # UIコンポーネント
│   │   ├── hooks/           # カスタムフック
│   │   ├── lib/             # ユーティリティ
│   │   ├── services/        # API通信
│   │   ├── stores/          # Zustand stores
│   │   └── types/           # TypeScript型定義
│   ├── public/
│   └── package.json
├── backend/                  # FastAPI アプリケーション
│   ├── app/
│   │   ├── api/
│   │   │   ├── endpoints/   # APIエンドポイント
│   │   │   └── deps.py      # 依存性注入
│   │   ├── core/            # 設定、セキュリティ
│   │   ├── models/          # SQLAlchemyモデル
│   │   ├── schemas/         # Pydanticスキーマ
│   │   ├── services/        # ビジネスロジック
│   │   └── main.py
│   ├── tests/
│   └── requirements.txt
├── database/
│   ├── migrations/          # DBマイグレーション
│   └── seeds/               # 初期データ
└── docker-compose.yml       # ローカル開発環境
```

### 3.3 環境変数（.env.example）

```bash
# Frontend (.env.local)
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx

# Backend (.env)
DATABASE_URL=postgresql://user:pass@localhost:5432/pdss
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=xxx
SECRET_KEY=xxx
CORS_ORIGINS=http://localhost:3000,https://yourdomain.com
SENTRY_DSN=xxx

# 共通
TZ=Asia/Tokyo
LOG_LEVEL=INFO
```

---

## 4. データベース設計（完全版）

### 4.1 ER図

```mermaid
erDiagram
    products ||--o{ price_simulations : has
    products ||--o{ sales_data : has
    fixed_costs ||--|| break_even_analysis : uses
    
    products {
        uuid id PK
        string product_code UK
        string product_name
        string category
        decimal unit_cost_per_kg
        decimal unit_price_per_kg
        decimal target_margin_rate
        decimal min_margin_rate
        string unit
        timestamp created_at
        timestamp updated_at
    }
    
    price_simulations {
        uuid id PK
        uuid product_id FK
        timestamp simulation_at
        decimal input_cost_per_kg
        decimal target_margin_rate
        decimal calculated_price_per_kg
        decimal selected_price_per_kg
        decimal quantity_kg
        decimal gross_profit_total
        jsonb parameters
        timestamp created_at
    }
    
    sales_data {
        uuid id PK
        uuid product_id FK
        date sale_date
        decimal quantity_kg
        decimal unit_price_per_kg
        decimal unit_cost_per_kg
        timestamp created_at
    }
    
    fixed_costs {
        uuid id PK
        date year_month
        decimal amount
        string category
        timestamp created_at
    }
```

### 4.2 テーブル定義（Supabase Migration）

```sql
-- Enable extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- For text search

-- Create enum types
CREATE TYPE price_status AS ENUM ('draft', 'approved', 'rejected');
CREATE TYPE risk_level AS ENUM ('safe', 'warning', 'danger');

-- Products table with full constraints
CREATE TABLE public.products (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    product_code VARCHAR(50) UNIQUE NOT NULL CHECK (product_code ~ '^[A-Z0-9\-]+$'),
    product_name VARCHAR(200) NOT NULL CHECK (length(product_name) > 0),
    category VARCHAR(100),
    unit_cost_per_kg NUMERIC(14,3) CHECK (unit_cost_per_kg > 0),
    unit_price_per_kg NUMERIC(14,3) CHECK (unit_price_per_kg > 0),
    target_margin_rate NUMERIC(6,4) CHECK (target_margin_rate >= 0 AND target_margin_rate < 1),
    min_margin_rate NUMERIC(6,4) CHECK (min_margin_rate >= 0 AND min_margin_rate < 1),
    unit TEXT NOT NULL DEFAULT 'JPY/kg',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT price_greater_than_cost CHECK (unit_price_per_kg > unit_cost_per_kg)
);

-- Create indexes
CREATE INDEX idx_products_code ON public.products(product_code);
CREATE INDEX idx_products_name ON public.products USING gin(product_name gin_trgm_ops);
CREATE INDEX idx_products_active ON public.products(is_active);

-- Price simulations with enhanced tracking
CREATE TABLE public.price_simulations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    product_id UUID REFERENCES public.products(id) ON DELETE CASCADE,
    simulation_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    input_cost_per_kg NUMERIC(14,3) NOT NULL CHECK (input_cost_per_kg > 0),
    target_margin_rate NUMERIC(6,4) NOT NULL CHECK (target_margin_rate >= 0 AND target_margin_rate < 1),
    calculated_price_per_kg NUMERIC(14,3) NOT NULL,
    selected_price_per_kg NUMERIC(14,3),
    quantity_kg NUMERIC(14,3) CHECK (quantity_kg >= 0),
    gross_profit_total NUMERIC(16,2),
    parameters JSONB DEFAULT '{}',
    status price_status DEFAULT 'draft',
    notes TEXT,
    created_by VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_simulations_product ON public.price_simulations(product_id);
CREATE INDEX idx_simulations_date ON public.price_simulations(simulation_at DESC);
CREATE INDEX idx_simulations_status ON public.price_simulations(status);

-- Fixed costs with validation
CREATE TABLE public.fixed_costs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    year_month DATE NOT NULL UNIQUE,
    amount NUMERIC(14,2) NOT NULL CHECK (amount >= 0),
    category VARCHAR(100) NOT NULL DEFAULT '固定費',
    breakdown JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_fixed_costs_month ON public.fixed_costs(year_month DESC);

-- Sales data for analysis
CREATE TABLE public.sales_data (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    product_id UUID REFERENCES public.products(id) ON DELETE CASCADE,
    sale_date DATE NOT NULL,
    quantity_kg NUMERIC(14,3) NOT NULL CHECK (quantity_kg > 0),
    unit_price_per_kg NUMERIC(14,3) NOT NULL CHECK (unit_price_per_kg > 0),
    unit_cost_per_kg NUMERIC(14,3) NOT NULL CHECK (unit_cost_per_kg > 0),
    customer_name VARCHAR(200),
    invoice_number VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_sales_product ON public.sales_data(product_id);
CREATE INDEX idx_sales_date ON public.sales_data(sale_date DESC);

-- Break-even analysis cache
CREATE TABLE public.break_even_analysis (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    year_month DATE NOT NULL,
    fixed_cost NUMERIC(14,2) NOT NULL,
    total_revenue NUMERIC(16,2) NOT NULL,
    total_variable_cost NUMERIC(16,2) NOT NULL,
    variable_cost_rate NUMERIC(6,4) NOT NULL,
    gross_margin_rate NUMERIC(6,4) NOT NULL,
    break_even_revenue NUMERIC(16,2) NOT NULL,
    actual_revenue NUMERIC(16,2),
    achievement_rate NUMERIC(6,3),
    risk_level risk_level NOT NULL,
    calculated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_break_even_month ON public.break_even_analysis(year_month DESC);

-- Import logs for traceability
CREATE TABLE public.import_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    import_type VARCHAR(50) NOT NULL,
    file_name VARCHAR(255),
    total_rows INTEGER,
    imported_rows INTEGER,
    skipped_rows INTEGER,
    error_details JSONB,
    imported_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Audit trigger function
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply audit triggers
CREATE TRIGGER update_products_updated_at BEFORE UPDATE ON public.products
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER update_fixed_costs_updated_at BEFORE UPDATE ON public.fixed_costs
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- Row Level Security
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.price_simulations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.fixed_costs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sales_data ENABLE ROW LEVEL SECURITY;

-- Initial data
INSERT INTO public.fixed_costs (year_month, amount, category, breakdown) VALUES
('2025-01-01', 4497000, '固定費', '{"人件費": 3000000, "家賃": 500000, "その他": 997000}'::jsonb),
('2025-02-01', 4112000, '固定費', '{"人件費": 3000000, "家賃": 500000, "その他": 612000}'::jsonb),
('2025-03-01', 3818000, '固定費', '{"人件費": 3000000, "家賃": 500000, "その他": 318000}'::jsonb),
('2025-04-01', 4044000, '固定費', '{"人件費": 3000000, "家賃": 500000, "その他": 544000}'::jsonb),
('2025-05-01', 4461000, '固定費', '{"人件費": 3000000, "家賃": 500000, "その他": 961000}'::jsonb),
('2025-06-01', 3707000, '固定費', '{"人件費": 3000000, "家賃": 500000, "その他": 207000}'::jsonb),
('2025-07-01', 8418000, '固定費', '{"人件費": 3000000, "家賃": 500000, "その他": 4918000}'::jsonb),
('2025-08-01', 4018000, '固定費', '{"人件費": 3000000, "家賃": 500000, "その他": 518000}'::jsonb);
```

---

## 5. API仕様（完全版）

### 5.1 共通仕様

```yaml
api_base_url: https://api.yourdomain.com/v1
content_type: application/json; charset=utf-8
authentication: Bearer Token (Supabase Auth)
rate_limiting: 100 requests/minute
timeout: 30 seconds

error_format:
  type: object
  properties:
    error:
      type: object
      properties:
        code: string
        message: string
        details: object
  example:
    error:
      code: "VALIDATION_ERROR"
      message: "入力値が不正です"
      details:
        field: "target_margin_rate"
        constraint: "must be between 0 and 0.9"
```

### 5.2 エンドポイント詳細

#### 価格シミュレーション

```yaml
endpoint: POST /api/price-simulations/calculate
description: 価格シミュレーション実行

request:
  type: object
  required: [product_name, unit_cost_per_kg, target_margin_rate]
  properties:
    product_name:
      type: string
      minLength: 1
      maxLength: 200
    unit_cost_per_kg:
      type: number
      minimum: 0.001
      maximum: 999999999.999
    target_margin_rate:
      type: number
      minimum: 0.0
      maximum: 0.9
    quantity_kg:
      type: number
      minimum: 0
      maximum: 999999999.999

response:
  type: object
  properties:
    recommended_price_per_kg:
      type: integer
      description: 推奨単価（円/kg、整数）
    gross_profit_per_kg:
      type: integer
      description: 粗利益（円/kg）
    gross_profit_total:
      type: integer
      description: 総粗利益（円）
    margin_rate:
      type: number
      description: 粗利率（0.xxx形式）
    price_patterns:
      type: array
      items:
        type: object
        properties:
          margin_rate: number
          price_per_kg: integer
          profit_per_kg: integer
    guard:
      type: object
      properties:
        min_allowed_price_per_kg: integer
        is_below_min: boolean
        warning_message: string

example_request:
  product_name: "商品A"
  unit_cost_per_kg: 620
  target_margin_rate: 0.20
  quantity_kg: 1000

example_response:
  recommended_price_per_kg: 775
  gross_profit_per_kg: 155
  gross_profit_total: 155000
  margin_rate: 0.20
  price_patterns:
    - margin_rate: 0.10
      price_per_kg: 689
      profit_per_kg: 69
    - margin_rate: 0.15
      price_per_kg: 729
      profit_per_kg: 109
    - margin_rate: 0.20
      price_per_kg: 775
      profit_per_kg: 155
    - margin_rate: 0.25
      price_per_kg: 827
      profit_per_kg: 207
    - margin_rate: 0.30
      price_per_kg: 886
      profit_per_kg: 266
  guard:
    min_allowed_price_per_kg: 775
    is_below_min: false
    warning_message: null
```

#### 損益分岐点分析

```yaml
endpoint: GET /api/break-even/current
description: 現在の損益分岐点情報取得

query_parameters:
  year_month:
    type: string
    format: YYYY-MM
    required: false
    default: current month

response:
  type: object
  properties:
    year_month: string
    fixed_costs: integer
    current_revenue: integer
    variable_cost_rate: number
    gross_margin_rate: number
    break_even_revenue: integer
    achievement_rate: number
    delta_revenue: integer
    status: enum[safe, warning, danger]
    trend:
      type: array
      items:
        type: object
        properties:
          month: string
          revenue: integer
          break_even: integer

example_response:
  year_month: "2025-08"
  fixed_costs: 4018000
  current_revenue: 25000000
  variable_cost_rate: 0.754
  gross_margin_rate: 0.246
  break_even_revenue: 16341463
  achievement_rate: 1.53
  delta_revenue: 8658537
  status: "safe"
  trend:
    - month: "2025-06"
      revenue: 23207000
      break_even: 15069106
    - month: "2025-07"
      revenue: 28722000
      break_even: 34235772
    - month: "2025-08"
      revenue: 25000000
      break_even: 16341463
```

#### Excel インポート

```yaml
endpoint: POST /api/import/excel
description: Excelファイルからデータインポート

request:
  type: multipart/form-data
  fields:
    file:
      type: file
      accept: .xlsx, .xls
      max_size: 10MB
    import_type:
      type: string
      enum: [products, sales]
    column_mapping:
      type: object
      description: 列マッピング設定
      properties:
        product_code: string
        product_name: string
        unit_cost: string
        unit_price: string
    unit_conversion:
      type: string
      enum: [yen_per_kg, thousand_yen_per_kg]
      default: thousand_yen_per_kg

response:
  type: object
  properties:
    success: boolean
    imported: integer
    skipped: integer
    errors:
      type: array
      items:
        type: object
        properties:
          row: integer
          column: string
          value: any
          reason: string
    warnings:
      type: array
      items:
        type: object
        properties:
          row: integer
          message: string

example_response:
  success: true
  imported: 8
  skipped: 2
  errors:
    - row: 3
      column: "C"
      value: "abc"
      reason: "数値でない値が入力されています"
    - row: 7
      column: "D"
      value: -100
      reason: "負の値は許可されていません"
  warnings:
    - row: 5
      message: "利益率が5%未満です"
```

### 5.3 WebSocket（リアルタイム更新）

```yaml
endpoint: wss://api.yourdomain.com/ws
description: リアルタイム更新用WebSocket

channels:
  break_even_updates:
    description: 損益分岐点の更新通知
    message_format:
      type: object
      properties:
        event: string
        data:
          type: object
          properties:
            year_month: string
            achievement_rate: number
            status: string

  price_alerts:
    description: 価格アラート通知
    message_format:
      type: object
      properties:
        event: string
        data:
          type: object
          properties:
            product_id: string
            alert_type: string
            message: string
```

---

## 6. 画面仕様（完全版）

### 6.1 画面一覧と遷移

```mermaid
graph TD
    A[ログイン画面] --> B[ダッシュボード]
    B --> C[価格シミュレーション]
    B --> D[損益分岐点詳細]
    B --> E[データインポート]
    B --> F[設定画面]
    C --> G[シミュレーション履歴]
    D --> H[月次比較]
    E --> I[インポート履歴]
```

### 6.2 画面詳細

#### ダッシュボード

```yaml
screen_name: ダッシュボード
url: /dashboard
layout: 2カラム（左：KPI、右：グラフ）

components:
  kpi_cards:
    - title: 今月の売上
      value: 現在の累計売上（千円表示）
      trend: 前月比（%）
    - title: 損益分岐点
      value: 分岐点売上高（千円表示）
      indicator: 達成率プログレスバー
    - title: 粗利率
      value: 今月の平均粗利率（%）
      status: safe/warning/danger色分け
    - title: 変動費率
      value: 今月の変動費率（%）
      chart: ミニスパークライン

  main_chart:
    type: 複合グラフ
    x_axis: 日付（1日〜月末）
    y_axis_left: 売上高（千円）
    y_axis_right: 粗利率（%）
    lines:
      - 日次売上（棒グラフ）
      - 累計売上（折れ線）
      - 損益分岐点（横線）
      - 粗利率（折れ線、右軸）

  quick_actions:
    - label: 価格シミュレーション
      icon: calculate
      link: /price-simulation
    - label: Excelインポート
      icon: upload
      link: /import
```

#### 価格シミュレーション画面

```yaml
screen_name: 価格シミュレーション
url: /price-simulation
layout: 左右分割（左：入力、右：結果）

left_panel:
  title: シミュレーション条件
  fields:
    - name: product_name
      type: autocomplete
      label: 商品名
      required: true
      data_source: /api/products/list
    - name: unit_cost_per_kg
      type: number
      label: 仕入原価（円/kg）
      required: true
      validation: min=0.01
      helper_text: 千円/kgの場合は1000倍して入力
    - name: target_margin_rate
      type: slider
      label: 目標粗利率（%）
      min: 0
      max: 90
      default: 20
      step: 1
    - name: quantity_kg
      type: number
      label: 販売予定量（kg）
      required: false
  
  actions:
    - label: 計算実行
      type: primary
      loading_state: true
    - label: クリア
      type: secondary

right_panel:
  title: シミュレーション結果
  sections:
    recommended_result:
      layout: card
      highlight: true
      fields:
        - label: 推奨販売価格
          value: calculated_price
          format: currency_per_kg
          size: large
        - label: 粗利益
          value: gross_profit
          format: currency_per_kg
        - label: 粗利率
          value: margin_rate
          format: percent
    
    price_patterns:
      layout: table
      columns:
        - field: margin_rate
          header: 粗利率
          format: percent
        - field: price_per_kg
          header: 販売価格
          format: currency_per_kg
        - field: profit_per_kg
          header: 粗利益
          format: currency_per_kg
      row_highlight: target_margin_rate
    
    validation_result:
      layout: alert
      conditions:
        - if: is_below_min
          type: error
          message: 最低売価を下回っています
        - if: margin_rate < 0.1
          type: warning
          message: 粗利率が10%未満です
        - else:
          type: success
          message: 適正価格です
```

### 6.3 UIコンポーネント仕様

```typescript
// 共通UIコンポーネント定義
interface UIComponents {
  // ボタン
  Button: {
    variants: ['primary', 'secondary', 'danger'];
    sizes: ['small', 'medium', 'large'];
    states: ['default', 'hover', 'active', 'disabled', 'loading'];
    minHeight: 44; // px (タッチターゲット)
  };
  
  // 入力フィールド
  TextField: {
    variants: ['standard', 'outlined'];
    validation: ['error', 'warning', 'success'];
    helperText: boolean;
    clearable: boolean;
  };
  
  // 数値入力
  NumberInput: {
    format: ['integer', 'decimal', 'currency'];
    thousandSeparator: true;
    precision: number;
    prefix?: string;
    suffix?: string;
  };
  
  // アラート
  Alert: {
    severity: ['error', 'warning', 'info', 'success'];
    variant: ['standard', 'outlined', 'filled'];
    closable: boolean;
  };
  
  // カラーパレット
  Colors: {
    primary: '#1976d2';
    secondary: '#dc004e';
    success: '#4caf50';
    warning: '#ff9800';
    error: '#f44336';
    background: '#fafafa';
    text: {
      primary: 'rgba(0, 0, 0, 0.87)';
      secondary: 'rgba(0, 0, 0, 0.54)';
    };
  };
  
  // フォント
  Typography: {
    fontFamily: '"Noto Sans JP", "Helvetica", "Arial", sans-serif';
    fontSize: {
      small: 12;
      body: 14;
      subtitle: 16;
      title: 20;
      heading: 24;
    };
  };
}
```

---

## 7. エラーハンドリング仕様

### 7.1 エラー分類と対処

```typescript
enum ErrorCode {
  // バリデーションエラー (400)
  VALIDATION_ERROR = "VALIDATION_ERROR",
  INVALID_PARAM = "INVALID_PARAM",
  MISSING_REQUIRED = "MISSING_REQUIRED",
  
  // 業務エラー (422)
  BELOW_MIN_PRICE = "BELOW_MIN_PRICE",
  EXCEEDS_MAX_MARGIN = "EXCEEDS_MAX_MARGIN",
  DUPLICATE_PRODUCT = "DUPLICATE_PRODUCT",
  
  // システムエラー (500)
  DATABASE_ERROR = "DATABASE_ERROR",
  CALCULATION_ERROR = "CALCULATION_ERROR",
  EXTERNAL_SERVICE_ERROR = "EXTERNAL_SERVICE_ERROR"
}

interface ErrorResponse {
  error: {
    code: ErrorCode;
    message: string;
    details?: any;
    user_action?: string; // ユーザーへの対処法
    support_id?: string;  // サポート問い合わせ用ID
  };
}

// エラーメッセージマッピング
const ERROR_MESSAGES: Record<ErrorCode, string> = {
  VALIDATION_ERROR: "入力内容に誤りがあります",
  INVALID_PARAM: "パラメータが不正です",
  MISSING_REQUIRED: "必須項目が入力されていません",
  BELOW_MIN_PRICE: "最低販売価格を下回っています",
  EXCEEDS_MAX_MARGIN: "粗利率が上限を超えています",
  DUPLICATE_PRODUCT: "同じ商品コードが既に存在します",
  DATABASE_ERROR: "データベースエラーが発生しました",
  CALCULATION_ERROR: "計算処理でエラーが発生しました",
  EXTERNAL_SERVICE_ERROR: "外部サービスでエラーが発生しました"
};
```

### 7.2 フロントエンドエラー表示

```typescript
// エラー表示コンポーネント
const ErrorBoundary: React.FC = ({ children }) => {
  const [error, setError] = useState<Error | null>(null);
  
  if (error) {
    return (
      <ErrorFallback
        error={error}
        resetErrorBoundary={() => setError(null)}
      />
    );
  }
  
  return (
    <ErrorBoundaryProvider value={{ setError }}>
      {children}
    </ErrorBoundaryProvider>
  );
};

// エラー通知
const showError = (error: ErrorResponse) => {
  const message = ERROR_MESSAGES[error.error.code] || "予期しないエラーが発生しました";
  const action = error.error.user_action || "しばらく待ってから再度お試しください";
  
  toast.error(
    <div>
      <Typography variant="subtitle2">{message}</Typography>
      <Typography variant="caption">{action}</Typography>
      {error.error.support_id && (
        <Typography variant="caption">
          サポートID: {error.error.support_id}
        </Typography>
      )}
    </div>
  );
};
```

---

## 8. テスト仕様

### 8.1 テストケース（必須実装）

```python
# backend/tests/test_price_calculation.py
import pytest
from decimal import Decimal

class TestPriceCalculation:
    """価格計算のテストケース"""
    
    @pytest.mark.parametrize("cost,margin,expected", [
        (620, 0.20, 775),      # 基本ケース
        (1000, 0.15, 1176),    # 整数コスト
        (999.999, 0.30, 1429), # 最大精度
        (0.001, 0.10, 0),      # 最小値
    ])
    def test_calculate_price(self, cost, margin, expected):
        """正常系：価格計算"""
        result = calculate_minimum_price(cost, margin)
        assert result == expected
    
    @pytest.mark.parametrize("cost,margin", [
        (-100, 0.20),  # 負のコスト
        (100, -0.1),   # 負のマージン
        (100, 1.0),    # 100%マージン
        (100, 1.5),    # 150%マージン
    ])
    def test_invalid_inputs(self, cost, margin):
        """異常系：不正な入力"""
        with pytest.raises(ValueError):
            calculate_minimum_price(cost, margin)
    
    def test_rounding(self):
        """丸め処理の確認"""
        assert round_jpy(775.4) == 775
        assert round_jpy(775.5) == 776
        assert round_jpy(775.6) == 776
    
    def test_break_even_calculation(self):
        """損益分岐点計算"""
        fixed_cost = 4018000
        gross_margin_rate = 0.246
        expected = 16341463
        result = calculate_break_even_revenue(fixed_cost, gross_margin_rate)
        assert abs(result - expected) < 1  # 誤差1円以内
```

### 8.2 E2Eテスト

```typescript
// frontend/e2e/price-simulation.spec.ts
import { test, expect } from '@playwright/test';

test.describe('価格シミュレーション', () => {
  test('正常な価格計算', async ({ page }) => {
    await page.goto('/price-simulation');
    
    // 入力
    await page.fill('[name="product_name"]', '商品A');
    await page.fill('[name="unit_cost_per_kg"]', '620');
    await page.fill('[name="target_margin_rate"]', '20');
    
    // 実行
    await page.click('button:has-text("計算実行")');
    
    // 検証
    await expect(page.locator('[data-testid="recommended-price"]'))
      .toContainText('775');
    await expect(page.locator('[data-testid="gross-profit"]'))
      .toContainText('155');
  });
  
  test('最低売価ガード', async ({ page }) => {
    await page.goto('/price-simulation');
    
    // 低すぎる価格を入力
    await page.fill('[name="proposed_price"]', '500');
    
    // 警告表示
    await expect(page.locator('.MuiAlert-standardError'))
      .toBeVisible();
    
    // 保存ボタン無効
    await expect(page.locator('button:has-text("保存")')).toBeDisabled();
  });
});
```

### 8.3 パフォーマンステスト

```yaml
performance_requirements:
  api_response_time:
    price_calculation: < 100ms
    break_even_analysis: < 200ms
    excel_import_1000rows: < 5000ms
  
  frontend_metrics:
    first_contentful_paint: < 1.8s
    time_to_interactive: < 3.5s
    cumulative_layout_shift: < 0.1
  
  load_test:
    concurrent_users: 10
    requests_per_second: 100
    error_rate: < 0.1%
```

---

## 9. セキュリティ要件

### 9.1 認証・認可

```typescript
// セキュリティ設定
const securityConfig = {
  // 認証
  authentication: {
    provider: 'Supabase Auth',
    method: 'JWT',
    tokenExpiry: '24h',
    refreshTokenExpiry: '7d'
  },
  
  // CORS設定
  cors: {
    origins: ['https://yourdomain.com'],
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    credentials: true
  },
  
  // レート制限
  rateLimit: {
    windowMs: 60 * 1000, // 1分
    max: 100 // リクエスト数
  },
  
  // CSP設定
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.yourdomain.com"]
    }
  }
};
```

### 9.2 データ保護

```sql
-- Row Level Security ポリシー
CREATE POLICY "Users can view their own data" ON public.products
  FOR SELECT USING (true);

CREATE POLICY "Users can insert their own data" ON public.products
  FOR INSERT WITH CHECK (true);

CREATE POLICY "Users can update their own data" ON public.products
  FOR UPDATE USING (true);

-- 監査ログ
CREATE TABLE public.audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID,
  action VARCHAR(50),
  table_name VARCHAR(50),
  record_id UUID,
  old_values JSONB,
  new_values JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## 10. 運用・保守

### 10.1 デプロイメント手順

```bash
# 1. 環境変数設定
cp .env.example .env.production
# 編集: DATABASE_URL, SUPABASE_KEY等

# 2. データベースマイグレーション
npm run migrate:production

# 3. フロントエンドビルド
cd frontend
npm run build
npm run deploy # Vercelへデプロイ

# 4. バックエンドデプロイ
cd backend
docker build -t pdss-api .
docker push registry.yourdomain.com/pdss-api
# Railway/Renderへデプロイ

# 5. ヘルスチェック
curl https://api.yourdomain.com/health
```

### 10.2 監視項目

```yaml
monitoring:
  uptime:
    - endpoint: /health
      interval: 60s
      timeout: 10s
  
  metrics:
    - api_response_time
    - error_rate
    - database_connection_pool
    - memory_usage
    - cpu_usage
  
  alerts:
    - name: high_error_rate
      condition: error_rate > 1%
      action: notify_slack
    - name: slow_response
      condition: p95_response_time > 1000ms
      action: notify_email
```

---

## 11. 付録

### 11.1 初期セットアップスクリプト

```bash
#!/bin/bash
# setup.sh - 初期環境構築スクリプト

set -e

echo "=== 価格設定支援システム セットアップ開始 ==="

# 1. 依存関係インストール
echo "1. 依存関係をインストール中..."
cd frontend && npm install
cd ../backend && pip install -r requirements.txt

# 2. データベース初期化
echo "2. データベースを初期化中..."
python -c "
from app.core.database import init_db
from app.core.config import settings
init_db(settings.DATABASE_URL)
"

# 3. 初期データ投入
echo "3. 初期データを投入中..."
python scripts/seed_data.py

# 4. 環境変数チェック
echo "4. 環境変数をチェック中..."
python scripts/check_env.py

echo "=== セットアップ完了 ==="
echo "以下のコマンドで起動できます："
echo "  フロントエンド: cd frontend && npm run dev"
echo "  バックエンド: cd backend && uvicorn app.main:app --reload"
```

### 11.2 トラブルシューティングガイド

```markdown
# よくある問題と解決方法

## Q1: 価格計算でエラーが発生する
**症状**: 「計算エラーが発生しました」と表示される
**原因**: 粗利率が90%を超えている可能性
**解決**: 粗利率を0〜90%の範囲で入力してください

## Q2: Excelインポートが失敗する
**症状**: インポート時に全件スキップされる
**原因**: 列マッピングが正しくない
**解決**: 設定画面で列マッピングを確認し、正しい列を指定してください

## Q3: ログインできない
**症状**: ログインボタンを押しても反応しない
**原因**: Supabaseの設定が正しくない
**解決**: .envファイルのSUPABASE_URLとSUPABASE_ANON_KEYを確認してください
```

---

## 12. 改訂履歴

```yaml
versions:
  - version: 2.0
    date: 2024-11-08
    changes:
      - AI実装用に全面改訂
      - エラーハンドリング詳細追加
      - テスト仕様追加
      - セキュリティ要件追加
  
  - version: 1.1
    date: 2024-11-08
    changes:
      - 単位と計算式の明確化
      - Excel取込機能追加
  
  - version: 1.0
    date: 2024-11-08
    changes:
      - 初版作成
```

---

**END OF DOCUMENT**

この要件定義書v2.0は、AIによる自動実装に必要なすべての情報を含んでいます。
曖昧な表現を排除し、具体的な実装指示として記述されています。
